<head>
    <script src="lib/codemirror.js"></script>

    <link rel="stylesheet" href="lib/codemirror.css">

    <script src="mode/mllike/mllike.js"></script>
    <script src="mode/javascript/javascript.js"></script>
    <script src="addon/edit/matchbrackets.js"></script>
    <title>OCaml to Javascript transplier playground</title>
</head>

<body>
<div style="height: 10000px">
    <div style="width: 50%;float:left">
<textarea id="ocamlcode#1">
let rec fib = function
  | 1 | 2 -> 1
  | n -> fib (n - 1 )  + fib (n - 2)
(** Imperative style *)
let sum n =
    let v  = ref 0 in
    for i = 0 to n do
       v := !v + i
    done;
    !v
(** List map *)
type 'a list =
  | Nil
  | Cons of 'a * 'a list

let rec map f = function
  | Nil -> Nil
  | Cons (x,xs) ->  Cons (f x, map f xs)

(** Test curry and uncurry calling convention *)
let test_curry x  y =  x + y
let f = test_curry 32

(** Create a typed binding for react *)
type t
type element
external document : unit -> t = "" [@@js.global "document"] [@@js.scope "window"]
external getElementById : t -> string -> element = "" [@@js.send "getElementById"]

(** Phantom types *)
type config
type component
type attrs
type component_class

external config :
      ?display_name:string ->
        render:(unit -> component) -> unit ->
          config = "" [@@js.obj ] (** make a json object *)
external attrs:
        ?alt: string ->
        ?autoPlay: bool ->
          unit -> attrs = "" [@@js.obj]
external str : string -> component = "%identity"
external h1 : ?attrs:attrs -> component array  -> component = ""
    [@@js.call "h1"] [@@js.scope "react" "DOM"] [@@js.splice] (** splice the last argument *)
external h2 : ?attrs:attrs -> component array  -> component = ""
    [@@js.call "h2"] [@@js.scope "react" "DOM"] [@@js.splice]
external div : ?attrs:attrs -> component array ->  component = ""
    [@@js.call "div"] [@@js.scope "react" "DOM"]  [@@js.splice]
external createClass :
      config -> component_class = "createClass"
        [@@js.call "createClass"]
        [@@js.scope "react"]
external render : component_class -> element -> unit = ""
    [@@js.call "render"]
    [@@js.scope "react-dom"]
;;
(** Do the rendering *)
render (
     createClass (
     (config
       ~render:(fun _ ->
         div
              ~attrs:(attrs ~alt:"pic" ())
              [|
                h1 [| str "hello react"|];
                h2 [| str "type safe!" |];
              |]
               )
        ()))) (getElementById (document ()) "hi")
</textarea>
    </div>
    <div style="width: 50%;float:right">
        <textarea id="jscode#1" style="background-color: #008803">
var ReactDom=require("react-dom");
var React=require("react");


var fib=function(n){return 1<-1+n>>>0?fib(n-1)+fib(n-2):1};

var sum=function(n){var v=0;for(var i=0;i<=n;i++){v=v+i;}return v};

var
 map=
  function(f,param)
   {return param?/* Cons */[0,f(param[1]),map(f,param[2])]:/* Nil */0};

var test_curry=function(x,y){return x+y};

var f=function(param){return test_curry(32,param)};

ReactDom["render"]
 (React["createClass"]
   ({"render":
     function(param)
      {return React["DOM"]["div"]
               ({"alt":"pic"},
                React["DOM"]["h1"](null,"hello react"),
                React["DOM"]["h2"](null,"type safe!"))}}),
  document["getElementById"]("hi"));
module["exports"]=
{"fib":fib,"sum":sum,"map":map,"test_curry":test_curry,"f":f};
</textarea>
    </div>
</div>
<!--<p> can you  see me</p>-->
<script>
    var codeMirrorDefaultHeight = 10000;
    var myCode1Mirror = CodeMirror.fromTextArea(
            document.getElementById('ocamlcode#1'),
            {
                mode:'text/x-ocaml',
                lineNumbers: true,
                lineWrapping: true,
                styleActiveLine:true,
            } );
    var jsCode1Mirror = CodeMirror.fromTextArea(
            document.getElementById('jscode#1'),
            { mode:'javascript',
                lineNumbers:true,
                readOnly: true,
                lineWrapping: true
            });
    jsCode1Mirror.setSize(null,codeMirrorDefaultHeight);
    myCode1Mirror.setSize(null,codeMirrorDefaultHeight);
    myCode1Mirror.on("changes", function (cm, change) {
        var raw = ocaml.compile(myCode1Mirror.getValue());
        console.log(raw);
        var rsp = JSON.parse(raw); // can we save this from parsing?
        if (rsp.js_code !== undefined) {
            jsCode1Mirror.setValue(rsp.js_code)
        } else {
            jsCode1Mirror.setValue(rsp.js_error_msg);
        }

    })

//var editor = CodeMirror.fromTextArea(document.getElementById('ocamlCode'), {
//    mode: 'text/x-ocaml',
//    lineNumbers: true,
//    matchBrackets: true
//})

//var jseditor = CodeMirror(document.getElementById('jsoutput')
//        ,
//        {
//    mode: 'javascript',
//    value: "var x= 3"
//})
</script>
<script type="text/javascript" src="./exports.js">    </script>
</body>
